# 버그 리포트: 관절 기즈모 작동 오류

**ID**: `BUG-001`
**생성일**: 2025년 9월 30일

---

### 문제 요약

마네킹의 특정 관절(예: 팔, 다리)을 더블클릭하면 회전 기즈모가 나타나지만, 이 기즈모를 사용해 관절을 회전시킨 후 마우스를 놓으면 관절이 원래의 위치로 되돌아갑니다. 즉, 기즈모를 통한 변경 사항이 저장되지 않습니다.

### 상세 설명

- **예상 동작**: 사용자가 기즈모를 드래그하여 관절을 회전시킨 후 마우스를 놓으면, 해당 관절의 새로운 회전 값이 애플리케이션 상태(store)에 저장되고 마네킹의 포즈가 영구적으로 변경되어야 합니다.
- **실제 동작**: 기즈모를 드래그하는 동안에는 관절이 시각적으로 회전하지만, 마우스를 놓는 순간 원래 포즈로 다시 돌아갑니다.
- **참고**: 오른쪽 패널의 슬라이더를 이용한 관절 제어는 정상적으로 작동합니다. 이로 보아 상태(state)를 업데이트하는 `setBoneRotation` 함수 자체에는 문제가 없을 가능성이 높습니다.

### 기술적 분석 및 디버깅 기록

1.  **`onMouseUp` 이벤트 핸들러 문제**: 최초 구현 시, 기즈모 조작이 끝났을 때 발생하는 `onMouseUp` 이벤트 핸들러에서 변경된 회전 값을 읽어오지 못하는 것으로 추정했습니다.
2.  **1차 수정**: 이벤트 객체(`e.target.object`) 대신, 기즈모가 직접 제어하는 `boneToControl` 객체에서 회전 값을 읽도록 수정했으나 실패했습니다.
3.  **현재 추정 원인 (Race Condition)**:
    - 기즈모를 드래그하는 동안에는 `useFrame` 루프가 상태를 덮어쓰지 않도록 `isDragging` 플래그로 보호하고 있습니다. 이 로직은 정상입니다.
    - 하지만, 사용자가 마우스를 놓는 순간 `onMouseUp` 이벤트가 발생하여 상태 업데이트를 요청하고, 거의 동시에 `isDragging` 플래그가 `false`로 바뀝니다.
    - 이 때, `setBoneRotation`에 의해 **상태가 업데이트되고 그 변경된 값이 컴포넌트의 `props`로 전달되기 전**에, `isDragging`이 `false`가 된 `useFrame` 루프가 먼저 실행될 가능성이 있습니다.
    - 결과적으로, `useFrame` 루프는 아직 변경 전의 **이전 `pose` 상태**를 3D 모델에 다시 적용해버리고, 이로 인해 기즈모의 변경 사항이 사라지는 현상이 발생하는 것으로 보입니다. (일종의 경합 상태, Race Condition)

### 향후 해결 방향

`onMouseUp` 이벤트와 `useFrame` 루프 간의 상태 동기화 문제를 해결해야 합니다. `onMouseUp` 핸들러에서 상태를 업데이트한 후, 다음 렌더링 프레임에서 이 값이 덮어씌워지지 않도록 보장하는 로직이 필요합니다.
